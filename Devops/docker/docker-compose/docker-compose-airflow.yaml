version: '3'

services:
# Postgres service
 postgres: 
  image: "postgres:latest"
  container_name: "postgres"
  environment:
   - POSTGRES_USER=airflow
   - POSTGRES_PASSWORD=airflow
   - POSTGRES_DB=airflow
  ports:
   - "5432:5432"
  volumes:
   - ./data/postgres:/var/lib/postgresql/data
 
# RabbitMQ service
 
# Apache Aiflow service 
 airflow: 
  image: localhost:5000/aiflow 
  build: .
  ports:
   - "8080:8080"
  depends_on: 
   - postgres
  volumes:
   - ./airflow_files/dags:/usr/local/airflow/dags

webserver:
    build: .
    restart: always
    depends_on:
     - postgres
    volumes:
     - ./airflow_files/dags:/usr/local/airflow/dags
    ports:
     - "8080:8080"
    entrypoint: airflow webserver
    healthcheck:
     test: ["CMD-SHELL", "[ -f /usr/local/airflow/airflow-webserver.pid ]"]
     interval: 30s
     timeout: 30s
     retries: 3
    