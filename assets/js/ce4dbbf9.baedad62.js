"use strict";(self.webpackChunktestdoc=self.webpackChunktestdoc||[]).push([[6768],{28453:(e,t,s)=>{s.d(t,{R:()=>o,x:()=>i});var a=s(96540);const n={},r=a.createContext(n);function o(e){const t=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),a.createElement(r.Provider,{value:t},e.children)}},79349:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"security/vault/dynamic-secret","title":"Vault Dynamic secret","description":"To follow this tutorial, you need a running vault server on kubernetes. If not you can run the following helm commands to setup Vault. is standard security practice to isolate secrets from code, and developers should not concern themselves with the origin of these secrets.","source":"@site/versioned_docs/version-1.0/security/vault/dynamic-secret.md","sourceDirName":"security/vault","slug":"/security/vault/dynamic-secret","permalink":"/Docs/docs/security/vault/dynamic-secret","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/versioned_docs/version-1.0/security/vault/dynamic-secret.md","tags":[],"version":"1.0","frontMatter":{},"sidebar":"securitySidebar","previous":{"title":"Single-Sing-On (SSO)","permalink":"/Docs/docs/security/sso/concepts"},"next":{"title":"headers","permalink":"/Docs/docs/security/web/headers"}}');var n=s(74848),r=s(28453);const o={},i="Vault Dynamic secret",c={},l=[{value:"Why Dynamic Secrets",id:"why-dynamic-secrets",level:2},{value:"What&#39;s Dynamic Secrets",id:"whats-dynamic-secrets",level:2},{value:"Postgresql",id:"postgresql",level:2},{value:"Create database",id:"create-database",level:3},{value:"Vault",id:"vault",level:2},{value:"Configure the plugin",id:"configure-the-plugin",level:3},{value:"Create a role",id:"create-a-role",level:3},{value:"Read from python",id:"read-from-python",level:2}];function d(e){const t={br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"vault-dynamic-secret",children:"Vault Dynamic secret"})}),"\n",(0,n.jsx)(t.p,{children:"To follow this tutorial, you need a running vault server on kubernetes. If not you can run the following helm commands to setup Vault. is standard security practice to isolate secrets from code, and developers should not concern themselves with the origin of these secrets.\r\nThis is where HashiCorp Vault comes in to centralize those secrets. In case one or multiple of these secrets get compromised, you'll need to revoke them and generate new ones to mitigate risks with minimal impact on the systems utilizing them."}),"\n",(0,n.jsx)(t.p,{children:"In this article, we'll cover how you can achieve that using Vault and to secure a PostgreSQL database. We will end by demonstrating how we can use these secrets with Python."}),"\n",(0,n.jsx)(t.h2,{id:"why-dynamic-secrets",children:"Why Dynamic Secrets"}),"\n",(0,n.jsx)(t.p,{children:"Here are some leaks that lead us to consider using Dynamic Secrets instead of Static Secrets."}),"\n",(0,n.jsx)(t.p,{children:"Applications frequently log configurations, leaving them in log files or centralized logging systems like Elasticsearch,\r\nwhich can be accessed by unauthorized individuals viewing your credentials."}),"\n",(0,n.jsx)(t.p,{children:"Often, secrets are captured in exception tracebacks while attempting to access the database, for instance.\r\nThese crash reports are sent to external monitoring systems, or they may be leaked via debugging endpoints and\r\ndiagnostic pages after encountering an error."}),"\n",(0,n.jsx)(t.p,{children:"It's common within organizations for multiple applications to share the same credentials to access other systems,\r\nsuch as a database. This means that rotating those passwords will impact all applications using those credentials.\r\nNow, imagine one of these applications getting compromised. It will require you to rotate these credentials across all your applications."}),"\n",(0,n.jsx)(t.p,{children:"All these challenges lead us to use a secret that can be generated and revoked on demand with less impact."}),"\n",(0,n.jsx)(t.h2,{id:"whats-dynamic-secrets",children:"What's Dynamic Secrets"}),"\n",(0,n.jsx)(t.p,{children:"From Harshicop Vault website:"}),"\n",(0,n.jsx)(t.p,{children:"A dynamic secret is generated on demand and is unique to a client, instead of a static secret, which is defined ahead of time and shared. Vault associates each dynamic secret with a lease and automatically destroys the credentials when the lease expires."}),"\n",(0,n.jsx)(t.h2,{id:"postgresql",children:"Postgresql"}),"\n",(0,n.jsx)(t.p,{children:"In this section, we assume that you already have a PostgreSQL database server running. Alternatively, if you're\r\na Kubernetes and Helm user, you can set up a PostgreSQL database server by executing the commands below."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'helm install postgres oci://registry-1.docker.io/bitnamicharts/postgresql\r\nkubectl get secret --namespace default postgres-postgresql -o jsonpath="{.data.postgres-password}" | base64 -d\n'})}),"\n",(0,n.jsx)(t.p,{children:"The PostgreSQL server that we are using throughout this tutorial can be accessed using the information below.\r\nPlease note that this information is temporary and local, and you cannot use it in your own environment."}),"\n",(0,n.jsx)(t.p,{children:"user: postgres\r\nport: 5432\r\npassword: FAKE_PWD\r\nhost: postgres-postgresql"}),"\n",(0,n.jsx)(t.h3,{id:"create-database",children:"Create database"}),"\n",(0,n.jsxs)(t.p,{children:["Connect to the database and create a database named ",(0,n.jsx)(t.em,{children:(0,n.jsx)(t.strong,{children:"dbtest"})}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"psql host=localhost port=5432 user=postgres password=SgOdV1ctSe\r\nCREATE DATABSE IF NOT EXISTS dbtest\n"})}),"\n",(0,n.jsx)(t.p,{children:"Above, we establish a connection to the database using the psql tool (alternatively, you can use any other\r\nPostgreSQL client tool). Subsequently, we execute the create database command to set up our schema."}),"\n",(0,n.jsx)(t.h2,{id:"vault",children:"Vault"}),"\n",(0,n.jsx)(t.p,{children:"Generating secrets dynamically for a PostgreSQL database can be done in two steps: configuring the plugin and creating a role."}),"\n",(0,n.jsx)(t.h3,{id:"configure-the-plugin",children:"Configure the plugin"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'vault login\r\n\r\nexport CONNECTION_URL="postgresql://{{username}}:{{password}}@postgres-postgresql:5432/dbtest"\r\nvault write database/config/my-postgresql-database \\\r\n    plugin_name="postgresql-database-plugin" \\\r\n    allowed_roles="my-role" \\\r\n    connection_url= ${CONNECTION_URL} \\\r\n    username="postgres" \\\r\n    password="FAKE_PWD" \\\r\n    password_authentication="scram-sha-256"\n'})}),"\n",(0,n.jsx)(t.h3,{id:"create-a-role",children:"Create a role"}),"\n",(0,n.jsxs)(t.p,{children:["Below, we create a role called ",(0,n.jsx)(t.strong,{children:"test-role"})," and then we mapped it to an SQL statement that will create a new database\r\nuser with select permision granted to",(0,n.jsx)(t.br,{}),"\n","all tables inside the ",(0,n.jsx)(t.strong,{children:"public"})," schema."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'vault write database/roles/test-role \\\r\n    db_name="my-postgresql-database" \\\r\n    creation_statements="CREATE ROLE \\"{{name}}\\" WITH LOGIN PASSWORD \'{{password}}\' VALID UNTIL \'{{expiration}}\'; \\\r\n        GRANT SELECT ON ALL TABLES IN SCHEMA public TO \\"{{name}}\\";" \\\r\n    default_ttl="1h" \\\r\n    max_ttl="24h"\r\n\r\nvault read database/creds/my-role\n'})}),"\n",(0,n.jsx)(t.h2,{id:"read-from-python",children:"Read from python"})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);