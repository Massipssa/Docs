// src/test/scala/fr/ccf/job/service/datacontract/DataContractGeneratorTest.scala
package fr.ccf.job.service.datacontract

import org.mockito.ArgumentCaptor
import org.mockito.ArgumentMatchers.{any => anyArg, eq => eqTo}
import org.mockito.Mockito.{verify, when}
import org.scalatest.PrivateMethodTester
import org.scalatest.matchers.should.Matchers
import org.scalatest.wordspec.AnyWordSpec
import org.scalatestplus.mockito.MockitoSugar

import java.io.InputStream
import java.nio.charset.StandardCharsets

class DataContractGeneratorTest
    extends AnyWordSpec
    with Matchers
    with MockitoSugar
    with PrivateMethodTester {

  "saveDataContractToS3" should {
    "upload YAML to S3 using the computed key and the job bucket" in {
      // GIVEN
      val s3 = mock[S3Service]

      // If JobConfigDto is a trait/class => mocking works
      implicit val jobConfigDto: JobConfigDto = mock[JobConfigDto]
      when(jobConfigDto.bucketName).thenReturn("my-bucket")
      when(jobConfigDto.context).thenReturn("dev")

      val yamlContent = "name: my_contract\nversion: v1\n"
      val objectId = "myObject"
      val version = "1.0.0"

      // WHEN
      DataContractGenerator.saveDataContractToS3(s3, yamlContent, objectId, version)

      // THEN (capture args)
      val keyCaptor = ArgumentCaptor.forClass(classOf[String])
      val isCaptor  = ArgumentCaptor.forClass(classOf[InputStream])

      verify(s3).putMultiPart(eqTo("my-bucket"), keyCaptor.capture(), isCaptor.capture())

      val uploadedKey = keyCaptor.getValue
      uploadedKey should include("dev")
      uploadedKey should include(objectId)
      uploadedKey should include(version)

      val uploadedText = new String(isCaptor.getValue.readAllBytes(), StandardCharsets.UTF_8)
      uploadedText shouldBe yamlContent
    }
  }

  "createDataContractPath" should {
    "build the S3 key using context + filename pattern" in {
      // GIVEN
      implicit val jobConfigDto: JobConfigDto = mock[JobConfigDto]
      when(jobConfigDto.context).thenReturn("int")

      val objectId = "OBJ"
      val version  = "2.3.4"

      // Access private method in the object
      val createPath = PrivateMethod[String](Symbol("createDataContractPath"))

      // WHEN
      val key =
        DataContractGenerator.invokePrivate(createPath(objectId, version, jobConfigDto))

      // THEN
      val expectedFileName =
        StorageConstants.DATACONTRACT_FILE_NAME_PATTERN.format(objectId, "int", version)

      val expectedKey =
        S3KeyUtil.createS3KeyWithFilename(
          List(StorageConstants.DATACONTRACT_APPL_ZONE_KEY, "int"),
          expectedFileName
        )

      key shouldBe expectedKey
    }
  }
}
