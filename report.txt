{% macro store_test_results(results, log_tbl=ref('dp_dq_tools', 'dq_issue_log'), batch=1000) %}
    {% set enable_store_result = var('dp_dq_tools_enable_store_test_results', false) %}
    
    {% if not enable_store_result or not execute %}
        {{ log("Ignored as `store_test_results` functionality is NOT being enabled.", true) if execute }}
        {% return %}
    {% endif %}
    
    {# Convert generator to a list for valid results filtering #}
    {% set valid_results = results | selectattr('node.resource_type', 'eq', 'test') | 
                                           rejectattr('status', 'in', ['error', 'skipped']) | list %}

    {% if valid_results | length == 0 %}
        {{ log("No valid test results to process.", true) if execute }}
        {% return %}
    {% endif %}
    
    {# Perform a single bulk insert for all valid results #}
    INSERT INTO {{ log_tbl }}
    SELECT
        timestamp as check_timestamp,
        table_name,
        table_query,
        column_name,
        ref_column,
        dq_issue_id as invocation_id,
        dbt_model,
        test_severity_config as severity,
        test_severity_config as kpi_category,
        no_of_records,
        no_of_records_scanned,
        no_of_records_failed,
        no_of_table_columns,
        test_unique_id
    FROM (
        {{ valid_results | map(attribute='result') | join(" UNION ALL ") }}
    );
{% endmacro %}
