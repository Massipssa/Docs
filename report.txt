import org.yaml.snakeyaml.{DumperOptions, Yaml}
import org.yaml.snakeyaml.nodes._
import org.yaml.snakeyaml.representer.Representer

import java.util.{Map => JMap}

// → détecte la map "storage_descriptor.value"
def isStorageDescriptorMap(m: JMap[_, _]): Boolean =
  m.containsKey("input_format") &&
    m.containsKey("output_format") &&
    m.containsKey("ser_de_info")

val options = new DumperOptions()
options.setDefaultFlowStyle(DumperOptions.FlowStyle.BLOCK)
options.setIndent(2)
options.setIndicatorIndent(2)
options.setPrettyFlow(true)        // permet FLOW multi-ligne propre

class StorageDescriptorRepresenter(options: DumperOptions)
    extends Representer(options) {

  // Indique si nous sommes actuellement dans la section storage_descriptor
  private var insideStorageDescriptor = false

  override protected def representMapping(
      tag: Tag,
      mapping: JMap[_, _],
      flowStyle: DumperOptions.FlowStyle
  ): MappingNode = {

    val previousState = insideStorageDescriptor
    if (isStorageDescriptorMap(mapping))
      insideStorageDescriptor = true

    val node = super.representMapping(tag, mapping, flowStyle)
      .asInstanceOf[MappingNode]

    if (insideStorageDescriptor)
      node.setFlowStyle(DumperOptions.FlowStyle.FLOW)
    else
      node.setFlowStyle(DumperOptions.FlowStyle.BLOCK)

    insideStorageDescriptor = previousState
    node
  }

  override protected def representScalar(
      tag: Tag,
      value: String,
      style: DumperOptions.ScalarStyle
  ): Node = {

    // si on est dans storage_descriptor → quotes
    if (insideStorageDescriptor)
      super.representScalar(tag, value, DumperOptions.ScalarStyle.DOUBLE_QUOTED)
    else
      super.representScalar(tag, value, DumperOptions.ScalarStyle.PLAIN)
  }
}

val representer = new StorageDescriptorRepresenter(options)
val yaml = new Yaml(representer, options)

val output = yaml.dump(root)   // root = ta Map racine
println(output)
