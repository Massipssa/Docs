import org.apache.spark.sql.{SparkSession, DataFrame}
import org.apache.spark.sql.functions._

val spark = SparkSession.builder()
  .appName("Compare with First Row")
  .master("local[*]")  // Remplace par le mode cluster si nÃ©cessaire
  .getOrCreate()

import spark.implicits._

// ğŸ“Œ 1ï¸âƒ£ CrÃ©ation du DataFrame avec des colonnes _c0 Ã  _c6
val df = Seq(
  ("A", "X", "1", "P", "Red", "100", "Yes"),  // ğŸ”¹ RÃ©fÃ©rence (1Ã¨re ligne)
  ("A", "X", "2", "Q", "Blue", "200", "No"),  // âŒ DiffÃ©rences dans _c2, _c3, _c4, _c5, _c6
  ("A", "Y", "1", "P", "Red", "100", "Yes"),  // âŒ DiffÃ©rence dans _c1
  ("C", "Z", "3", "P", "Red", "100", "Yes"),  // âŒ DiffÃ©rences dans _c0, _c1, _c2
  ("A", "X", "1", "P", "Red", "100", "Yes")   // âœ… Identique Ã  la 1Ã¨re ligne
).toDF("_c0", "_c1", "_c2", "_c3", "_c4", "_c5", "_c6")

// ğŸ“Œ 2ï¸âƒ£ Appliquer `first()` sur chaque colonne pour rÃ©cupÃ©rer la premiÃ¨re valeur
val firstValuesExprs = df.columns.map(c => first(col(c)).over() as s"${c}_first")

// ğŸ“Œ 3ï¸âƒ£ SÃ©lectionner toutes les colonnes originales + leurs valeurs de rÃ©fÃ©rence
val dfWithFirstValues = df.select(
  df.columns.map(col) ++ firstValuesExprs: _*
)

// ğŸ“Œ 4ï¸âƒ£ Comparer chaque colonne avec sa premiÃ¨re valeur et stocker les colonnes diffÃ©rentes
val diffColumnsExpr = concat_ws(
  ", ",
  df.columns.map(c => when(col(c) =!= col(s"${c}_first"), lit(c))).reduce(_ +: _)
).alias("diff_columns")

// ğŸ“Œ 5ï¸âƒ£ Ajouter les valeurs de rÃ©fÃ©rence dans une seule colonne
val referenceValuesExpr = concat_ws(
  ", ",
  df.columns.map(c => when(col(c) =!= col(s"${c}_first"), col(s"${c}_first"))).reduce(_ +: _)
).alias("reference_values")

// ğŸ“Œ 6ï¸âƒ£ Ajouter les colonnes de comparaison au DataFrame
val dfWithDifferences = dfWithFirstValues.withColumn("diff_columns", diffColumnsExpr)
  .withColumn("reference_values", referenceValuesExpr)

// ğŸ“Œ 7ï¸âƒ£ Filtrer uniquement les lignes diffÃ©rentes de la premiÃ¨re
val diffDf = dfWithDifferences.filter(col("diff_columns") =!= "")

// ğŸ“Œ 8ï¸âƒ£ SÃ©lectionner uniquement les colonnes originales + les diffÃ©rences et valeurs de rÃ©fÃ©rence
val finalDf = diffDf.select(df.columns.map(col) ++ Seq(col("diff_columns"), col("reference_values")): _*)

// ğŸ“Œ 9ï¸âƒ£ Affichage des lignes qui diffÃ¨rent de la premiÃ¨re ligne
finalDf.show(false)
