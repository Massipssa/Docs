object BatchBuilder {

  private def artifactTypeFromKey(key: String): ArtifactType =
    if (key.contains("/DATA/")) ArtifactType.DATA
    else if (key.contains("/PARAMETRAGE/")) ArtifactType.PARAMETRAGE
    else if (key.contains("/METADATA/")) ArtifactType.METADATA
    else if (key.contains("/MONITORING/")) ArtifactType.MONITORING
    else ArtifactType.AUTRES

  private def fileName(key: String): String =
    key.split("/").last

  private def s3Path(bucket: String, key: String): String =
    s"s3://$bucket/$key"

  private def isValidName(name: String): Boolean =
    name.matches("^[A-Z0-9_.-]+$")

  def createBatch(
    s3: S3Service,
    bucket: String,
    batchId: String,
    source: String,
    untarredPrefixKey: String
  ): Batch = {

    val keys = s3.listKeys(bucket, untarredPrefixKey)

    val artifacts = keys.map { key =>
      val tpe = artifactTypeFromKey(key)
      val name = fileName(key)
      val path = s3Path(bucket, key)

      tpe match {
        case ArtifactType.METADATA | ArtifactType.MONITORING =>
          Artifact(name, tpe, path, None)

        case _ =>
          if (isValidName(name))
            Artifact(name, tpe, path, Some(ArtifactStatus.IN_PROGRESS))
          else
            Artifact(name, tpe, path, Some(ArtifactStatus.IGNORED), Some("invalid name"))
      }
    }

    val now = Time.now

    Batch(
      batchId = batchId,
      source = source,
      status = BatchStatus.RUNNING,
      createdAt = now,
      updatedAt = now,
      untarredPrefix = s3Path(bucket, untarredPrefixKey),

      cre = artifacts.filter(_.artifactType == ArtifactType.DATA),
      gesparam = artifacts.filter(_.artifactType == ArtifactType.PARAMETRAGE),
      autres = artifacts.filter(_.artifactType == ArtifactType.AUTRES),
      metadata = artifacts.filter(_.artifactType == ArtifactType.METADATA),
      monitoring = artifacts.filter(_.artifactType == ArtifactType.MONITORING)
    )
  }
}
