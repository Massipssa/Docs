package fr.ccf.commons.datacontract

import org.mockito.ArgumentMatchers.any
import org.mockito.Mockito._
import org.mockito.{MockedConstruction, Mockito}
import org.scalatest.matchers.should.Matchers
import org.scalatest.wordspec.AnyWordSpec
import org.yaml.snakeyaml.DumperOptions
import org.yaml.snakeyaml.Yaml

import java.util.{LinkedHashMap => JLinkedHashMap, List => JList}
import scala.jdk.CollectionConverters._

class DataContractGeneratorSpec extends AnyWordSpec with Matchers {

  "generate(contract)" should {

    "build root map and dump it with expected DumperOptions" in {
      // ⬇️ Remplace par ta vraie classe
      val generator = new DataContractGenerator()

      // DataContract minimal : schema vide pour éviter la complexité de toSchemaList
      val contract = DataContract(
        kind = "DataContract",
        apiVersion = "v3.0.2",
        id = "ignored",
        status = "ACTIVE",
        schema = Nil // <- important : évite d'avoir à construire un Schema complet
      )

      val mockedYaml: MockedConstruction[Yaml] =
        Mockito.mockConstruction(
          classOf[Yaml],
          (yamlMock: Yaml, context) => {
            when(yamlMock.dump(any())).thenReturn("DUMPED_YAML")

            // ✅ Vérifie les DumperOptions passées à new Yaml(represent, options)
            val options = context.arguments().get(1).asInstanceOf[DumperOptions]

            options.getDefaultFlowStyle shouldBe DumperOptions.FlowStyle.BLOCK
            options.isPrettyFlow shouldBe true
            options.getIndent shouldBe 2
            options.getWidth shouldBe 120
            options.getDefaultScalarStyle shouldBe DumperOptions.ScalarStyle.PLAIN
          }
        )

      try {
        val out = generator.generate(contract)
        out shouldBe "DUMPED_YAML"

        // ✅ Vérifie l'argument passé à dump(root)
        val yamlInstance = mockedYaml.constructed().get(0)
        val captor = org.mockito.ArgumentCaptor.forClass(classOf[Object])
        verify(yamlInstance).dump(captor.capture())

        val root = captor.getValue.asInstanceOf[JLinkedHashMap[String, Any]]
        root.asScala.keySet shouldBe Set("kind", "apiVersion", "id", "status", "schema")

        root.get("kind") shouldBe "DataContract"
        root.get("apiVersion") shouldBe "v3.0.2"
        root.get("id") shouldBe "ignored"
        root.get("status") shouldBe "ACTIVE"

        val schemaValue = root.get("schema")
        schemaValue shouldBe a[JList[?]]
        schemaValue.asInstanceOf[JList[?]].size() shouldBe 0
      } finally {
        mockedYaml.close()
      }
    }
  }
}
