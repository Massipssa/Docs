import java.nio.file.{Files, Path, StandardCopyOption}
import com.amazonaws.services.s3.model.{ObjectMetadata, PutObjectRequest}

def putSafe(bucket: String, key: String, in: java.io.InputStream, contentType: String): Unit = {
  val tmp: Path = Files.createTempFile("s3-put-", ".tmp")
  try {
    Files.copy(in, tmp, StandardCopyOption.REPLACE_EXISTING)
    val size = Files.size(tmp)

    val md = new ObjectMetadata()
    md.setContentLength(size)
    md.setContentType(contentType)

    s3Client.putObject(new PutObjectRequest(bucket, key, tmp.toFile).withMetadata(md))
  } finally {
    try in.close() catch { case _: Throwable => () }
    try Files.deleteIfExists(tmp) catch { case _: Throwable => () }
  }
}
