{% macro kpi(execute=false) %}
    {# Check if results exist and are iterable #}
    {%- if results is not none and results | length > 0 -%}
        {%- for result in results if result.node.resource_type | lower == 'test' and result.status -%}
            {# Dynamically build the SELECT clause with fields starting with "result" #}
            {%- set select_fields = [] -%}
            {%- for key, value in result.items() if key.startswith('result') -%}
                {%- do select_fields.append("'" ~ value ~ "' AS " ~ key) -%}
            {%- endfor -%}

            {# Construct the INSERT statement dynamically #}
            {%- set insert_statement = (
                "INSERT INTO dbt_retail_ccf_sit_database.kpi "
                "SELECT " ~ select_fields | join(', ')
            ) -%}

            {# Execute each INSERT statement separately #}
            {%- if execute -%}
                {%- do run_query(insert_statement) -%}
                {{ log("Inserted result for: " ~ result.node.unique_id, true) }}
            {%- endif -%}
        {%- endfor -%}
    {%- else -%}
        {{ log("No results to process.", true) }}
    {%- endif -%}
{% endmacro %}
