trait S3Service {
  def uploadMultipart(key: String, input: InputStream, partSize: Int): CompleteMultipartUploadResult
  def listAllKeys(prefix: String): List[S3ObjectSummary]
  def extractFilenameFromKey(objectKey: String): Option[String]
  def buildKey(parts: List[String], filename: String): String
  def splitKey(key: String): List[String]
  def containsKeyPart(key: String, part: String): Boolean
  def delete(key: String): Unit
}

class AwsS3Service(s3Client: AmazonS3, bucketName: String) extends S3Service {

  private val delimiter = "/"

  override def uploadMultipart(key: String, input: InputStream, partSize: Int): CompleteMultipartUploadResult = {
    val uploadId = s3Client.initiateMultipartUpload(new InitiateMultipartUploadRequest(bucketName, key)).getUploadId
    val buffer = new Array[Byte](partSize)

    def readStream(stream: InputStream): LazyList[(Int, Array[Byte])] = {
      val bytes = new Array[Byte](partSize)
      val read = stream.read(bytes)
      if (read == -1) LazyList.empty
      else (read, bytes.take(read)) #:: readStream(stream)
    }

    val partETags = readStream(input).zipWithIndex.map { case ((read, chunk), idx) =>
      val partStream = new ByteArrayInputStream(chunk)
      val partRequest = new UploadPartRequest()
        .withBucketName(bucketName)
        .withKey(key)
        .withUploadId(uploadId)
        .withPartNumber(idx + 1)
        .withInputStream(partStream)
        .withPartSize(read)

      val result = s3Client.uploadPart(partRequest)
      new PartETag(result.getPartNumber, result.getETag)
    }.toList.asJava

    s3Client.completeMultipartUpload(new CompleteMultipartUploadRequest(bucketName, key, uploadId, partETags))
  }

  override def listAllKeys(prefix: String): List[S3ObjectSummary] = {
    val req = new ListObjectsV2Request().withBucketName(bucketName).withPrefix(prefix)

    @tailrec
    def paginate(token: String, acc: List[S3ObjectSummary]): List[S3ObjectSummary] = {
      if (token != null) req.setContinuationToken(token)
      val result = s3Client.listObjectsV2(req)
      val newSummaries = result.getObjectSummaries.asScala.toList
      if (result.isTruncated) paginate(result.getNextContinuationToken, acc ++ newSummaries)
      else acc ++ newSummaries
    }

    paginate(null, Nil)
  }

  override def extractFilenameFromKey(objectKey: String): Option[String] =
    Option(objectKey)
      .filter(_.nonEmpty)
      .map(_.split(delimiter))
      .flatMap(_.lastOption)

  override def buildKey(parts: List[String], filename: String): String =
    (parts :+ filename).mkString(delimiter)
}

class AwsS3Service(s3Client: AmazonS3, bucketName: String) extends S3Service {

  private val delimiter = "/"

  // Split key into parts using delimiter
  override def splitKey(key: String): List[String] = {
    Option(key)
      .filter(_.nonEmpty)
      .map(_.split(delimiter).toList)
      .getOrElse {
        logger.warn("Provided key is null or empty")
        List.empty
      }
  }

  // Check if part exists in S3 key
  override def containsKeyPart(key: String, part: String): Boolean = {
    splitKey(key).contains(part)
  }

  // Delete an object from S3
  override def delete(key: String): Unit = {
    if (Option(key).exists(_.nonEmpty)) {
      s3Client.deleteObject(bucketName, key)
      logger.info(s"Deleted object: $key from bucket: $bucketName")
    } else {
      logger.warn("Cannot delete object: key is null or empty")
    }
  }

  // Other methods...
}
