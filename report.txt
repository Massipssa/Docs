class StorageDescriptorRepresenter(opts: DumperOptions)
  extends Representer(opts) {

  private var inside = false

  private def isStorageDescriptorContext(m: JMap[_, _]): Boolean =
    m.containsKey("property") &&
      "storage_descriptor" == String.valueOf(m.get("property"))

  private def isStorageDescriptorValue(m: JMap[_, _]): Boolean =
    m.containsKey("input_format") &&
      m.containsKey("output_format") &&
      m.containsKey("ser_de_info")

  // ***** SIGNATURE EXACTE SnakeYAML 2.4 *****
  override protected def representMapping(
    tag: Tag,
    mapping: JMap[_, _],
    flowStyle: DumperOptions.FlowStyle
  ): Node = {

    val prev = inside
    if (prev || isStorageDescriptorContext(mapping))
      inside = true

    val node = super.representMapping(tag, mapping, flowStyle)
      .asInstanceOf[MappingNode]

    if (isStorageDescriptorValue(mapping))
      node.setFlowStyle(DumperOptions.FlowStyle.FLOW)
    else
      node.setFlowStyle(DumperOptions.FlowStyle.BLOCK)

    inside = prev
    node
  }

  override protected def representScalar(
    tag: Tag,
    value: String,
    style: DumperOptions.ScalarStyle
  ): Node = {

    if (inside)
      super.representScalar(tag, value, DumperOptions.ScalarStyle.DOUBLE_QUOTED)
    else
      super.representScalar(tag, value, DumperOptions.ScalarStyle.PLAIN)
  }
}
